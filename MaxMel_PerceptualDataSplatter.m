% Define the paths
dropboxBasePath = '/Users/spitschan/Dropbox (Aguirre-Brainard Lab)/MELA_materials/MaxMelPulsePsychophysics';
outDir = fullfile(pwd, 'figures');
if ~isdir(outDir)
    mkdir(outDir);
end

% Define the # of subjects
NSubjects = 20;

subjectIDs={...
    'MELA_0074',...
    'MELA_0087',...
    'MELA_0089',...
    'MELA_0026',...
    'MELA_0082',...
    'MELA_0038',...
    'MELA_0094',...
    'MELA_0096',...
    'MELA_0088',...
    'MELA_0079',...
    'MELA_0043',...
    'MELA_0073',...
    'MELA_0080',... 
    'MELA_0090',...
    'MELA_0037',...
    'MELA_0049',...
    'MELA_0050',...
    'MELA_0075',...
    'MELA_0077',...
    'MELA_0081',...
    };

theMelData = {'040517/Cache-MelanopsinDirectedSuperMaxMel_MELA_0074_040517' ...
    '040417/Cache-MelanopsinDirectedSuperMaxMel_MELA_0087_040417' ...
    '033117/Cache-MelanopsinDirectedSuperMaxMel_MELA_0089_033117' ...
    '033117/Cache-MelanopsinDirectedSuperMaxMel_MELA_0026_033117' ...
    '032917/Cache-MelanopsinDirectedSuperMaxMel_MELA_0082_032917' ...
    '032917/Cache-MelanopsinDirectedSuperMaxMel_MELA_0038_032917' ...
    '021417/Cache-MelanopsinDirectedSuperMaxMel_MELA_0094_021417' ...
    '032817/Cache-MelanopsinDirectedSuperMaxMel_MELA_0096_032817' ...
    '032117/Cache-MelanopsinDirectedSuperMaxMel_MELA_0088_032117' ...
    '032017/Cache-MelanopsinDirectedSuperMaxMel_MELA_0079_032017' ...
    '022717/Cache-MelanopsinDirectedSuperMaxMel_MELA_0043_022717' ...
    '022717/Cache-MelanopsinDirectedSuperMaxMel_MELA_0073_022717' ...
    '022117/Cache-MelanopsinDirectedSuperMaxMel_MELA_0080_022117' ...
    '022117/Cache-MelanopsinDirectedSuperMaxMel_MELA_0090_022117' ...
    '021717/Cache-MelanopsinDirectedSuperMaxMel_MELA_0037_021717' ...
    '020317/Cache-MelanopsinDirectedSuperMaxMel_MELA_0049_020317' ...
    '020717/Cache-MelanopsinDirectedSuperMaxMel_MELA_0050_020717' ...
    '020617/Cache-MelanopsinDirectedSuperMaxMel_MELA_0075_020617' ...
    '020817/Cache-MelanopsinDirectedSuperMaxMel_MELA_0077_020817' ...
    '021017/Cache-MelanopsinDirectedSuperMaxMel_MELA_0081_021017'};

theLMSData = {'040517/Cache-LMSDirectedSuperMaxLMS_MELA_0074_040517' ...
    '040417/Cache-LMSDirectedSuperMaxLMS_MELA_0087_040417' ...
    '033117/Cache-LMSDirectedSuperMaxLMS_MELA_0089_033117' ...
    '033117/Cache-LMSDirectedSuperMaxLMS_MELA_0026_033117' ...
    '032917/Cache-LMSDirectedSuperMaxLMS_MELA_0082_032917' ...
    '032917/Cache-LMSDirectedSuperMaxLMS_MELA_0038_032917' ...
    '021417/Cache-LMSDirectedSuperMaxLMS_MELA_0094_021417' ...
    '032817/Cache-LMSDirectedSuperMaxLMS_MELA_0096_032817' ...
    '032117/Cache-LMSDirectedSuperMaxLMS_MELA_0088_032117' ...
    '032017/Cache-LMSDirectedSuperMaxLMS_MELA_0079_032017' ...
    '022717/Cache-LMSDirectedSuperMaxLMS_MELA_0043_022717' ...
    '022717/Cache-LMSDirectedSuperMaxLMS_MELA_0073_022717' ...
    '022117/Cache-LMSDirectedSuperMaxLMS_MELA_0080_022117' ...
    '022117/Cache-LMSDirectedSuperMaxLMS_MELA_0090_022117' ...
    '021717/Cache-LMSDirectedSuperMaxLMS_MELA_0037_021717' ...
    '020317/Cache-LMSDirectedSuperMaxLMS_MELA_0049_020317' ...
    '020717/Cache-LMSDirectedSuperMaxLMS_MELA_0050_020717' ...
    '020617/Cache-LMSDirectedSuperMaxLMS_MELA_0075_020617' ...
    '020817/Cache-LMSDirectedSuperMaxLMS_MELA_0077_020817' ...
    '021017/Cache-LMSDirectedSuperMaxLMS_MELA_0081_021017'};

% Load the files
for d = 1:NSubjects
    % Load the mel data first
    dataPath = theMelData{d};
    
    % Find the folders
    theFolders = dir(fullfile(dropboxBasePath, dataPath))
    
    for k = length(theFolders):-1:1
        % remove non-folders
        if ~theFolders(k).isdir
            theFolders(k) = [ ];
            continue;
        end
        
        % remove folders starting with .
        fname = theFolders(k).name;
        if fname(1) == '.'
            theFolders(k) = [ ];
        end
    end
    
    % Iterate over the folders
    for f = 1:length(theFolders)
        % Go to the folder
        if isdir(fullfile(dropboxBasePath, dataPath, theFolders(f).name))
            cd(fullfile(dropboxBasePath, dataPath, theFolders(f).name));
        end
        
        % Find the only MAT file there is going to be
        theMATFile = dir([pwd '/*.mat']);
        
        if ~isempty(theMATFile)
            % Load the MAT file
            tmp = load(theMATFile.name);
            
            % Get the background spectrum
            bgSpdVal(:, f) = tmp.cals{1}.modulationBGMeas.meas.pr650.spectrum;
            bgSpdNom = tmp.cals{1}.modulationBGMeas.predictedSpd;
            
            % Calculate the contrast
            NContrastLevels = size(tmp.cals{end}.modulationAllMeas, 2)-1;
            for kk = 2:NContrastLevels+1
                modSpdVal{kk-1}(:, f) = tmp.cals{1}.modulationAllMeas(1, kk).meas.pr650.spectrum;
            end
        end
    end
    bgSpdValMean = mean(bgSpdVal, 2);
    bgSpdValSD = std(bgSpdVal, [], 2);
end